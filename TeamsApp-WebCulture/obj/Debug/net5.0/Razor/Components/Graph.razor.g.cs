#pragma checksum "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "c4549311941b9b5f6547e69079bf1176684fc8d4"
// <auto-generated/>
#pragma warning disable 1591
namespace TeamsApp_WebCulture.Components
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture.Interop.TeamsSDK;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.Fast.Components.FluentUI;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.TeamsFx;

#line default
#line hidden
#nullable disable
#nullable restore
#line 1 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using System.IO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using Azure.Core;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using Microsoft.Graph;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using Microsoft.TeamsFx.Model;

#line default
#line hidden
#nullable disable
    public partial class Graph : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
            __builder.OpenElement(0, "div");
            __builder.AddMarkupContent(1, "<h2>Get the user\'s profile photo</h2>\r\n    ");
            __builder.AddMarkupContent(2, "<p>Click below to authorize this app to read your profile photo using Microsoft Graph.</p>\r\n    ");
            __builder.OpenComponent<Microsoft.Fast.Components.FluentUI.FluentButton>(3);
            __builder.AddAttribute(4, "Appearance", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.Fast.Components.FluentUI.Appearance?>(
#nullable restore
#line 11 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                              Appearance.Accent

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(5, "Disabled", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<System.Boolean?>(
#nullable restore
#line 11 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                                                            IsLoading

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(6, "hidden", 
#nullable restore
#line 11 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                                                                                 Profile != null

#line default
#line hidden
#nullable disable
            );
            __builder.AddAttribute(7, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 11 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                                                                                                             Reload

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(8, "ChildContent", (Microsoft.AspNetCore.Components.RenderFragment)((__builder2) => {
                __builder2.AddContent(9, "Authorize");
            }
            ));
            __builder.CloseComponent();
#nullable restore
#line 12 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
     if (IsLoading)
    {

#line default
#line hidden
#nullable disable
            __builder.OpenComponent<TeamsApp_WebCulture.Components.ProfileCard>(10);
            __builder.AddAttribute(11, "IsLoading", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<System.Boolean>(
#nullable restore
#line 14 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                                true

#line default
#line hidden
#nullable disable
            ));
            __builder.CloseComponent();
#nullable restore
#line 15 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
    }
    else if (!IsLoading && !string.IsNullOrEmpty(@ErrorMessage))
    {

#line default
#line hidden
#nullable disable
            __builder.OpenElement(12, "div");
            __builder.AddAttribute(13, "class", "error");
#nullable restore
#line 18 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
__builder.AddContent(14, ErrorMessage);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
#nullable restore
#line 19 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
    }
    else if (!IsLoading && Profile != null)
    {

#line default
#line hidden
#nullable disable
            __builder.OpenComponent<TeamsApp_WebCulture.Components.ProfileCard>(15);
            __builder.AddAttribute(16, "IsLoading", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<System.Boolean>(
#nullable restore
#line 22 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                                false

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(17, "Profile", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.Graph.User>(
#nullable restore
#line 22 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                                                 Profile

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(18, "UserPhotoUri", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<System.String>(
#nullable restore
#line 22 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
                                                                         UserPhotoUri

#line default
#line hidden
#nullable disable
            ));
            __builder.CloseComponent();
#nullable restore
#line 23 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
    }

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
        }
        #pragma warning restore 1998
#nullable restore
#line 26 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
       
    [Parameter]
    public string ErrorMessage { get; set; }

    public bool IsLoading { get; set; }
    public User Profile { get; set; }
    public string UserPhotoUri { get; set; }

    private readonly string _scope = "User.Read";

    private async Task Reload()
    {
        IsLoading = true;

        try
        {
            await teamsUserCredential.GetTokenAsync(new TokenRequestContext(new string[] { _scope }), new System.Threading.CancellationToken());
        }
        catch (ExceptionWithCode e)
        {
            if(e.Code == ExceptionCode.UiRequiredError)
            {
                if (!await GetConsent())
                {
                    IsLoading = false;
                    ErrorMessage = e.Message;
                    return;   
                }
            }
            else{
                IsLoading = false;
                ErrorMessage = e.Message;
                return;
            }
        }

        var graph = GetGraphServiceClient();

        Profile = await graph.Me.Request().GetAsync();
        UserPhotoUri = await GetPhotoAsync(graph);

        IsLoading = false;
        ErrorMessage = string.Empty;
    }

    private async Task<bool> GetConsent()
    {
        try
        {
            await teamsUserCredential.LoginAsync(_scope);
            await teamsUserCredential.GetTokenAsync(new TokenRequestContext(new string[] { _scope }), new System.Threading.CancellationToken());
            return true;
        }
        catch (ExceptionWithCode e)
        {
            return false;
        }
    }
    
    private GraphServiceClient GetGraphServiceClient()
    {
        var msGraphAuthProvider = new MsGraphAuthProvider(teamsUserCredential, _scope);
        var client = new GraphServiceClient(msGraphAuthProvider);
        return client;
    }

    private async Task<string> GetPhotoAsync(GraphServiceClient graph)
    {
        string userPhoto = "";
        try
        {
            var photoStream = await graph.Me.Photo.Content.Request().GetAsync();

            if (photoStream != null)
            {
                // Copy the photo stream to a memory stream
                // to get the bytes out of it
                var memoryStream = new MemoryStream();
                photoStream.CopyTo(memoryStream);
                var photoBytes = memoryStream.ToArray();

                // Generate a data URI for the photo
                userPhoto = $"data:image/png;base64,{Convert.ToBase64String(photoBytes)}";
            }
        }
        catch (Exception) { /* Unable to get the users photo */ }

        return userPhoto;
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TeamsUserCredential teamsUserCredential { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TeamsFx teamsfx { get; set; }
    }
}
#pragma warning restore 1591
