// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace TeamsApp_WebCulture.Components
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture.Interop.TeamsSDK;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using TeamsApp_WebCulture.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.Fast.Components.FluentUI;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\_Imports.razor"
using Microsoft.TeamsFx;

#line default
#line hidden
#nullable disable
#nullable restore
#line 1 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using System.IO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using Azure.Core;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using Microsoft.Graph;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
using Microsoft.TeamsFx.Model;

#line default
#line hidden
#nullable disable
    public partial class Graph : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 26 "C:\Users\mittall\source\repos\TeamsApp-WebCulture\TeamsApp-WebCulture\Components\Graph.razor"
       
    [Parameter]
    public string ErrorMessage { get; set; }

    public bool IsLoading { get; set; }
    public User Profile { get; set; }
    public string UserPhotoUri { get; set; }

    private readonly string _scope = "User.Read";

    private async Task Reload()
    {
        IsLoading = true;

        try
        {
            await teamsUserCredential.GetTokenAsync(new TokenRequestContext(new string[] { _scope }), new System.Threading.CancellationToken());
        }
        catch (ExceptionWithCode e)
        {
            if(e.Code == ExceptionCode.UiRequiredError)
            {
                if (!await GetConsent())
                {
                    IsLoading = false;
                    ErrorMessage = e.Message;
                    return;   
                }
            }
            else{
                IsLoading = false;
                ErrorMessage = e.Message;
                return;
            }
        }

        var graph = GetGraphServiceClient();

        Profile = await graph.Me.Request().GetAsync();
        UserPhotoUri = await GetPhotoAsync(graph);

        IsLoading = false;
        ErrorMessage = string.Empty;
    }

    private async Task<bool> GetConsent()
    {
        try
        {
            await teamsUserCredential.LoginAsync(_scope);
            await teamsUserCredential.GetTokenAsync(new TokenRequestContext(new string[] { _scope }), new System.Threading.CancellationToken());
            return true;
        }
        catch (ExceptionWithCode e)
        {
            return false;
        }
    }
    
    private GraphServiceClient GetGraphServiceClient()
    {
        var msGraphAuthProvider = new MsGraphAuthProvider(teamsUserCredential, _scope);
        var client = new GraphServiceClient(msGraphAuthProvider);
        return client;
    }

    private async Task<string> GetPhotoAsync(GraphServiceClient graph)
    {
        string userPhoto = "";
        try
        {
            var photoStream = await graph.Me.Photo.Content.Request().GetAsync();

            if (photoStream != null)
            {
                // Copy the photo stream to a memory stream
                // to get the bytes out of it
                var memoryStream = new MemoryStream();
                photoStream.CopyTo(memoryStream);
                var photoBytes = memoryStream.ToArray();

                // Generate a data URI for the photo
                userPhoto = $"data:image/png;base64,{Convert.ToBase64String(photoBytes)}";
            }
        }
        catch (Exception) { /* Unable to get the users photo */ }

        return userPhoto;
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TeamsUserCredential teamsUserCredential { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TeamsFx teamsfx { get; set; }
    }
}
#pragma warning restore 1591
